<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™»å½• - å®¶åº­ç‡ƒæ°”ç›‘æ§ä¸­å¿ƒ</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        background: #f7f8fb;
        color: #333;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login-container {
        background: #fff;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }

      .logo {
        text-align: center;
        margin-bottom: 32px;
      }

      .logo h1 {
        margin: 0 0 8px;
        font-size: 24px;
        color: #111827;
      }

      .logo p {
        margin: 0;
        color: #6b7280;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn {
        width: 100%;
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background: #2563eb;
        color: #fff;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-primary:disabled {
        background: #93c5fd;
        cursor: not-allowed;
      }

      .error-message {
        background: #fee2e2;
        border: 1px solid #ef4444;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        color: #991b1b;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .success-message {
        background: #dcfce7;
        border: 1px solid #22c55e;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        color: #166534;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .footer {
        margin-top: 24px;
        text-align: center;
        color: #6b7280;
        font-size: 13px;
      }

      .footer a {
        color: #2563eb;
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .login-container {
          margin: 16px;
          padding: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="logo">
        <h1>ğŸ”¥ å®¶åº­ç‡ƒæ°”ç›‘æ§ä¸­å¿ƒ</h1>
        <p>è¯·ç™»å½•ç®¡ç†å‘˜è´¦å·</p>
      </div>

      <!-- é”™è¯¯æç¤º -->
      <div id="error-message" class="error-message"></div>

      <!-- æˆåŠŸæç¤º -->
      <div id="success-message" class="success-message"></div>

      <div
        id="login-info"
        style="margin-bottom: 12px; color: #374151; font-size: 14px"
      ></div>
      <div style="margin-bottom: 12px">
        <button
          type="button"
          id="clear-token"
          class="btn"
          style="background: #374151; color: #fff"
        >
          é€€å‡ºå½“å‰ç™»å½•
        </button>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <form id="login-form">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
            required
            autocomplete="username"
          />
        </div>

        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="è¯·è¾“å…¥å¯†ç "
            required
            autocomplete="current-password"
          />
        </div>

        <button type="submit" class="btn btn-primary" id="login-btn">
          ç™»å½•
        </button>
      </form>

      <div class="footer">
        <a href="/">è¿”å›é¦–é¡µ</a>
      </div>
    </div>

    <script>
      const API_BASE = "/api";

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = "âš ï¸ " + message;
        errorDiv.classList.add("show");
        hideSuccess();
      }

      // æ¸…é™¤é”™è¯¯ä¿¡æ¯
      function clearError() {
        const errorDiv = document.getElementById("error-message");
        errorDiv.classList.remove("show");
      }

      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      function showSuccess(message) {
        const successDiv = document.getElementById("success-message");
        successDiv.textContent = "âœ… " + message;
        successDiv.classList.add("show");
      }

      // æ¸…é™¤æˆåŠŸä¿¡æ¯
      function hideSuccess() {
        const successDiv = document.getElementById("success-message");
        successDiv.classList.remove("show");
      }

      // æ£€æŸ¥è®¤è¯çŠ¶æ€
      async function checkAuthStatus() {
        const token = localStorage.getItem("gas_token");
        const info = document.getElementById("login-info");
        try {
          const res = await fetch(`${API_BASE}/auth/status`, {
            credentials: "include",
            headers: {
              ...(token ? { Authorization: `Bearer ${token}` } : {}),
            },
          });
          if (res.ok) {
            const data = await res.json();
            const notes = [];
            notes.push(data.enabled ? "å‚æ•°è®¾ç½®ç™»å½•ä¿æŠ¤å·²å¼€å¯" : "ç™»å½•ä¿æŠ¤å½“å‰å…³é—­ï¼Œå¯åœ¨è®¾ç½®é¡µå¼€å¯");
            if (!data.configured) {
              notes.push("å°šæœªè®¾ç½®ç®¡ç†å‘˜ï¼Œé¦–æ¬¡ç™»å½•ä¼šåˆ›å»ºè´¦å·");
            }
            if (info) {
              info.textContent = notes.join(" Â· ");
            }
            const logoutBtn = document.getElementById("clear-token");
            if (logoutBtn) {
              logoutBtn.style.display = data.authenticated ? "inline-block" : "none";
            }
            if (data.enabled && data.configured && data.authenticated) {
              // å·²ç™»å½•ï¼Œè·³è½¬åˆ°è®¾ç½®é¡µ
              window.location.href = "/data-import";
            }
          }
        } catch (e) {
          // å¿½ç•¥é”™è¯¯
        }
      }

      document.getElementById("clear-token").addEventListener("click", () => {
        localStorage.removeItem("gas_token");
        fetch("/api/logout", { method: "POST", credentials: "include" }).finally(() => {
          showSuccess("å·²é€€å‡ºç™»å½•ï¼Œå¯é‡æ–°ç™»å½•");
          const logoutBtn = document.getElementById("clear-token");
          if (logoutBtn) logoutBtn.style.display = "none";
        });
      });

      // ç™»å½•è¡¨å•æäº¤
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          clearError();

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const loginBtn = document.getElementById("login-btn");

          if (!username || !password) {
            showError("è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ");
            return;
          }

          loginBtn.disabled = true;
          loginBtn.textContent = "ç™»å½•ä¸­...";

          try {
            const res = await fetch(`${API_BASE}/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.error || "ç™»å½•å¤±è´¥");
            }

            // ä¿å­˜ Token
            localStorage.setItem("gas_token", data.token);

            showSuccess("ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...");

            setTimeout(() => {
              window.location.href = "/data-import";
            }, 1000);
          } catch (err) {
            showError(err.message);
            loginBtn.disabled = false;
            loginBtn.textContent = "ç™»å½•";
          }
        });

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      checkAuthStatus();
    </script>
  </body>
</html>
