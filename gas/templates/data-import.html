<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç‡ƒæ°”å‚æ•°è®¾ç½®</title>
    <script src="/static/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        background: #f7f8fb;
        color: #333;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      header {
        background: #111827;
        color: #fff;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .card {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
      }

      .form-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 500;
      }

      input[type="text"],
      input[type="number"],
      input[type="password"],
      input[type="date"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-sizing: border-box;
      }

      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background: #1d4ed8;
      }

      button.danger {
        background: #dc2626;
      }

      button.danger:hover {
        background: #b91c1c;
      }

      button.success {
        background: #10b981;
      }

      button.warning {
        background: #f59e0b;
      }

      .actions {
        margin-top: 16px;
        display: flex;
        gap: 12px;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background: #f9fafb;
        font-weight: 600;
      }

      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
      }

      .alert.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .alert.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }

      .alert.info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
      }

      /* ç§»åŠ¨ç«¯é€‚é… */
      @media (max-width: 640px) {
        body {
          padding: 10px;
        }

        header {
          padding: 16px;
        }

        .card {
          padding: 16px;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1>âš™ï¸ ç‡ƒæ°”å‚æ•°è®¾ç½®</h1>
            <p>MQTTã€Telegram é€šçŸ¥å’Œç³»ç»Ÿå‚æ•°é…ç½®</p>
          </div>
          <div style="display: flex; gap: 12px">
            <a
              href="/"
              style="
                color: white;
                text-decoration: none;
                padding: 8px 16px;
                background: #374151;
                border-radius: 6px;
              "
              >ğŸ  è¿”å›é¦–é¡µ</a
            >
            <button
              id="logout-btn"
              style="
                color: white;
                padding: 8px 16px;
                background: #dc2626;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                display: none;
              "
            >
              é€€å‡º
            </button>
          </div>
        </div>
      </header>

      <div id="alert-container"></div>

      <!-- MQTT é…ç½® -->
      <div class="card">
        <h2>ğŸ“¡ MQTT é…ç½®</h2>
        <form id="settings-form">
          <div class="form-grid">
            <label>
              æ¯è„‰å†²æ°”é‡ (mÂ³/pulse)
              <input type="text" name="gas_per_pulse" />
            </label>
            <label>
              MQTT Host
              <input type="text" name="mqtt_host" />
            </label>
            <label>
              MQTT Port
              <input type="number" name="mqtt_port" />
            </label>
            <label>
              MQTT ç”¨æˆ·å
              <input type="text" name="mqtt_user" />
            </label>
            <label>
              MQTT å¯†ç 
              <input type="password" name="mqtt_password" />
            </label>
            <label>
              MQTT Topic
              <input type="text" name="mqtt_topic" />
            </label>
            <label> <input type="checkbox" name="mqtt_tls" /> å¯ç”¨ TLS </label>
            <label>
              <input type="checkbox" name="mqtt_tls_insecure" /> è·³è¿‡è¯ä¹¦æ ¡éªŒ
            </label>
          </div>

          <div class="actions">
            <button type="submit">ä¿å­˜é…ç½®</button>
            <button type="button" id="load-config">åˆ·æ–°é…ç½®</button>
          </div>
        </form>
      </div>

      <!-- Telegram é€šçŸ¥é…ç½® -->
      <div class="card">
        <h2>ğŸ“± Telegram é€šçŸ¥</h2>
        <form id="telegram-form">
          <div class="form-grid">
            <label>
              <input type="checkbox" name="tg_enabled" /> å¯ç”¨ Telegram é€šçŸ¥
            </label>
            <label>
              Bot Token
              <input type="password" name="tg_bot_token" />
            </label>
            <label>
              Chat ID
              <input type="text" name="tg_chat_id" />
            </label>
            <label>
              API ç«¯ç‚¹
              <input
                type="text"
                name="tg_api_endpoint"
                placeholder="https://api.telegram.org"
              />
            </label>
            <label>
              é¢„è­¦é˜ˆå€¼ (mÂ³)
              <input type="text" name="tg_threshold" />
            </label>
            <label>
              é€šçŸ¥æ¬¡æ•°
              <input type="number" name="tg_notify_times" />
            </label>
            <label>
              é€šçŸ¥é—´éš” (å°æ—¶)
              <input type="text" name="tg_notify_interval_hours" />
            </label>
          </div>

          <div class="actions">
            <button type="submit" class="success">ä¿å­˜é€šçŸ¥è®¾ç½®</button>
            <button type="button" id="test-telegram" class="warning">
              æµ‹è¯•é€šçŸ¥
            </button>
          </div>
        </form>
      </div>

      <!-- ç³»ç»Ÿæ ¡å‡†è®¾ç½® -->
      <div class="card">
        <h2>âš™ï¸ ç³»ç»Ÿæ ¡å‡†è®¾ç½®</h2>
        <p>æ ¡å‡†ç³»ç»Ÿå‚æ•°ï¼Œç¡®ä¿è„‰å†²è®¡æ•°ä¸ç‡ƒæ°”è¡¨è¯»æ•°åŒ¹é…</p>

        <div class="form-grid">
          <label>
            èµ·å§‹ç‡ƒæ°”é‡ (mÂ³)
            <input type="text" id="cal-initial-gas" step="0.01" />
          </label>
          <label>
            ç‡ƒæ°”è¡¨åº•æ•° (mÂ³)
            <input type="text" id="cal-meter-base" step="0.01" />
          </label>
          <label>
            ç›®æ ‡è¡¨è¯»æ•° (mÂ³)
            <input type="text" id="cal-desired-meter" step="0.01" />
          </label>
        </div>

        <div class="actions">
          <button onclick="calibrateSettings()">ğŸ”§ æ‰§è¡Œæ ¡å‡†</button>
          <button onclick="loadCalibrateSettings()">ğŸ“¥ åŠ è½½å½“å‰è®¾ç½®</button>
        </div>
      </div>

      <!-- æ•°æ®è®¾ç½®å·¥å…· -->
      <div class="card">
        <h2>ğŸ“… æ•°æ®è®¾ç½®å·¥å…·</h2>
        <p>æ‰‹åŠ¨è®¾ç½®ç‰¹å®šæ—¥æœŸçš„ç”¨æ°”é‡ï¼Œç”¨äºæµ‹è¯•æˆ–æ•°æ®æ ¡æ­£</p>

        <div class="form-grid">
          <label>
            æ—¥æœŸ
            <input type="date" id="date" max="" />
          </label>
          <label>
            ç´¯è®¡è„‰å†²æ•°
            <input type="number" id="count" placeholder="ä¾‹å¦‚: 12345" min="0" />
          </label>
          <label>
            æ—¶é—´ (å¯é€‰)
            <input type="text" id="time" placeholder="ä¾‹å¦‚: 14:30 (24å°æ—¶åˆ¶)" />
          </label>
        </div>

        <div class="actions">
          <button onclick="saveData()" class="success">ğŸ’¾ ä¿å­˜æ•°æ®</button>
          <button onclick="loadCurrentData()">ğŸ“¥ åŠ è½½å½“å‰æ•°æ®</button>
          <button onclick="clearDataForm()">ğŸ”„ æ¸…ç©ºè¡¨å•</button>
        </div>
      </div>

      <!-- å¿«é€Ÿæ‰¹é‡è®¾ç½® -->
      <div class="card">
        <h2>ğŸ“Š å¿«é€Ÿæ‰¹é‡è®¾ç½®</h2>
        <p>æ‰¹é‡è®¾ç½®è¿ç»­å‡ å¤©çš„æ•°æ®ï¼ˆæ¯å¤©å¢åŠ å›ºå®šè„‰å†²æ•°ï¼‰</p>

        <div class="form-grid">
          <label>
            å¼€å§‹æ—¥æœŸ
            <input type="date" id="start-date" />
          </label>
          <label>
            ç»“æŸæ—¥æœŸ
            <input type="date" id="end-date" />
          </label>
          <label>
            æ¯æ—¥å¢åŠ è„‰å†²æ•°
            <input
              type="number"
              id="daily-increase"
              placeholder="ä¾‹å¦‚: 100"
              min="0"
            />
          </label>
          <label>
            èµ·å§‹ç´¯è®¡æ•°
            <input
              type="number"
              id="start-count"
              placeholder="ä¾‹å¦‚: 10000"
              min="0"
            />
          </label>
        </div>

        <div class="actions">
          <button onclick="batchSetData()">ğŸ“Š æ‰¹é‡è®¾ç½®</button>
        </div>
      </div>

      <!-- æŸ¥çœ‹ç°æœ‰æ•°æ® -->
      <div class="card">
        <h2>ğŸ“ ç°æœ‰æ•°æ®</h2>
        <button onclick="loadRecentData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>

        <div class="table-container">
          <table id="data-table">
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ç´¯è®¡è„‰å†²</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="data-tbody">
              <tr>
                <td colspan="3" style="text-align: center; color: #666">
                  ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½ç°æœ‰æ•°æ®
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "/api";
      const REQUEST_TIMEOUT = 10000; // 10ç§’è¶…æ—¶

      // è®¾ç½®æ—¥æœŸè¾“å…¥çš„æœ€å¤§å€¼ä¸ºä»Šå¤©
      document.getElementById("date").max = new Date()
        .toISOString()
        .split("T")[0];
      document.getElementById("start-date").max = new Date()
        .toISOString()
        .split("T")[0];
      document.getElementById("end-date").max = new Date()
        .toISOString()
        .split("T")[0];

      function showAlert(message, type = "info") {
        const container = document.getElementById("alert-container");
        container.innerHTML = `<div class="alert ${type}">${message}</div>`;
        setTimeout(() => {
          container.innerHTML = "";
        }, 5000);
      }

      // å¸¦è¶…æ—¶çš„ fetch è¯·æ±‚ï¼ˆå¸¦è®¤è¯ï¼‰
      async function fetchJSON(path, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        // è·å– token
        const token = localStorage.getItem("gas_token");
        const headers = {
          "Content-Type": "application/json",
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
          ...options.headers,
        };

        try {
          const res = await fetch(`${API_BASE}${path}`, {
            headers,
            signal: controller.signal,
            ...options,
          });
          clearTimeout(timeoutId);

          // å¤„ç† 401 æœªæˆæƒ
          if (res.status === 401) {
            localStorage.removeItem("gas_token");
            showAlert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•", "error");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
            throw new Error("æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ");
          }

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || res.statusText);
          }
          return res.json();
        } catch (err) {
          clearTimeout(timeoutId);
          if (err.name === "AbortError") {
            throw new Error("è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
          }
          throw err;
        }
      }

      // æ£€æŸ¥è®¤è¯çŠ¶æ€å¹¶æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
      async function checkAuthAndShowLogout() {
        const token = localStorage.getItem("gas_token");
        const logoutBtn = document.getElementById("logout-btn");
        if (token) {
          logoutBtn.style.display = "block";
        }
      }

      // é€€å‡ºç™»å½•
      document.getElementById("logout-btn")?.addEventListener("click", () => {
        localStorage.removeItem("gas_token");
        window.location.href = "/";
      });

      // åŠ è½½æ‰€æœ‰é…ç½®åˆ°è¡¨å•
      async function loadAllSettings() {
        try {
          const settings = await fetchJSON("/settings");

          // MQTT é…ç½®
          const settingsForm = document.getElementById("settings-form");
          Object.entries(settings).forEach(([key, value]) => {
            const field = settingsForm.elements[key];
            if (!field) return;
            if (field.type === "checkbox") {
              field.checked = Boolean(value);
            } else {
              field.value = value || "";
            }
          });

          // Telegram é…ç½®ï¼ˆåœ¨åŒä¸€ä¸ª form ä¸­ï¼‰
          const telegramForm = document.getElementById("telegram-form");
          Object.entries(settings).forEach(([key, value]) => {
            const field = telegramForm.elements[key];
            if (!field) return;
            if (field.type === "checkbox") {
              field.checked = Boolean(value);
            } else {
              field.value = value || "";
            }
          });
        } catch (err) {
          showAlert("åŠ è½½é…ç½®å¤±è´¥: " + err.message, "error");
          console.error("åŠ è½½é…ç½®å¤±è´¥:", err);
        }
      }

      // ä¿å­˜æ‰€æœ‰é…ç½®
      async function saveAllSettings() {
        const settingsForm = document.getElementById("settings-form");
        const payload = {
          gas_per_pulse: settingsForm.elements.gas_per_pulse.value,
          mqtt_host: settingsForm.elements.mqtt_host.value,
          mqtt_port: Number(settingsForm.elements.mqtt_port.value || 0),
          mqtt_user: settingsForm.elements.mqtt_user.value,
          mqtt_password: settingsForm.elements.mqtt_password.value,
          mqtt_topic: settingsForm.elements.mqtt_topic.value,
          mqtt_tls: settingsForm.elements.mqtt_tls.checked,
          mqtt_tls_insecure: settingsForm.elements.mqtt_tls_insecure.checked,
        };

        try {
          await fetchJSON("/settings", {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          showAlert("MQTT é…ç½®å·²ä¿å­˜", "success");
        } catch (err) {
          showAlert("ä¿å­˜å¤±è´¥: " + err.message, "error");
          console.error("ä¿å­˜é…ç½®å¤±è´¥:", err);
        }
      }

      // ä¿å­˜ Telegram é€šçŸ¥è®¾ç½®
      async function saveTelegramSettings() {
        const telegramForm = document.getElementById("telegram-form");
        const payload = {
          tg_enabled: telegramForm.elements.tg_enabled.checked,
          tg_bot_token: telegramForm.elements.tg_bot_token.value,
          tg_chat_id: telegramForm.elements.tg_chat_id.value,
          tg_api_endpoint: telegramForm.elements.tg_api_endpoint.value,
          tg_threshold: telegramForm.elements.tg_threshold.value,
          tg_notify_times: Number(
            telegramForm.elements.tg_notify_times.value || 0
          ),
          tg_notify_interval_hours:
            telegramForm.elements.tg_notify_interval_hours.value,
        };

        try {
          await fetchJSON("/settings", {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          showAlert("Telegram é…ç½®å·²ä¿å­˜", "success");
        } catch (err) {
          showAlert("ä¿å­˜å¤±è´¥: " + err.message, "error");
          console.error("ä¿å­˜é…ç½®å¤±è´¥:", err);
        }
      }

      // æµ‹è¯• Telegram é€šçŸ¥
      async function testTelegram() {
        try {
          await fetchJSON("/notify/test", { method: "POST" });
          showAlert("æµ‹è¯•é€šçŸ¥å·²å‘é€", "success");
        } catch (err) {
          let errorMsg = err.message;
          if (err.message.includes("telegram not configured")) {
            errorMsg =
              "Telegram æœªé…ç½®ã€‚è¯·å…ˆé…ç½® Bot Token å’Œ Chat IDï¼Œå¹¶å¯ç”¨ Telegram é€šçŸ¥ã€‚";
          } else if (err.message.includes("disabled")) {
            errorMsg = 'Telegram é€šçŸ¥æœªå¯ç”¨ã€‚è¯·å…ˆå‹¾é€‰"å¯ç”¨ Telegram é€šçŸ¥"ã€‚';
          } else if (err.message.includes("401")) {
            errorMsg = "Bot Token æ— æ•ˆï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®ã€‚";
          } else if (err.message.includes("404")) {
            errorMsg = "Chat ID æ— æ•ˆï¼Œè¯·æ£€æŸ¥ Chat ID æ˜¯å¦æ­£ç¡®ã€‚";
          } else if (err.message.includes("400")) {
            errorMsg = "è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯ã€‚";
          } else if (err.message.includes("Failed to send")) {
            errorMsg = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– API ç«¯ç‚¹é…ç½®ã€‚";
          }
          showAlert("æµ‹è¯•å¤±è´¥: " + errorMsg, "error");
          console.error("æµ‹è¯•é€šçŸ¥å¤±è´¥:", err);
        }
      }

      // æ ¡å‡†è®¾ç½®
      async function calibrateSettings() {
        const initialGas = document.getElementById("cal-initial-gas").value;
        const meterBase = document.getElementById("cal-meter-base").value;
        const desiredMeter = document.getElementById("cal-desired-meter").value;

        if (!initialGas && !meterBase && !desiredMeter) {
          showAlert("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæ ¡å‡†å‚æ•°", "error");
          return;
        }

        try {
          const payload = {};
          if (initialGas) payload.initial_gas = initialGas;
          if (meterBase) payload.meter_base_m3 = meterBase;
          if (desiredMeter) payload.desired_meter_m3 = desiredMeter;

          await fetchJSON("/calibrate", {
            method: "POST",
            body: JSON.stringify(payload),
          });

          showAlert("æ ¡å‡†å®Œæˆï¼è®¾ç½®å·²æ›´æ–°", "success");
          clearCalibrateForm();
        } catch (err) {
          showAlert("æ ¡å‡†å¤±è´¥: " + err.message, "error");
        }
      }

      // åŠ è½½æ ¡å‡†è®¾ç½®
      async function loadCalibrateSettings() {
        try {
          const settings = await fetchJSON("/settings");

          document.getElementById("cal-initial-gas").value =
            settings.initial_gas || "";
          document.getElementById("cal-meter-base").value =
            settings.meter_base_m3 || "";
          document.getElementById("cal-desired-meter").value =
            settings.desired_meter_m3 || "";

          showAlert("å·²åŠ è½½å½“å‰è®¾ç½®", "success");
        } catch (err) {
          showAlert("åŠ è½½è®¾ç½®å¤±è´¥: " + err.message, "error");
        }
      }

      function clearCalibrateForm() {
        document.getElementById("cal-initial-gas").value = "";
        document.getElementById("cal-meter-base").value = "";
        document.getElementById("cal-desired-meter").value = "";
      }

      // æ•°æ®è®¾ç½®ç›¸å…³å‡½æ•°
      function getDateTime() {
        const date = document.getElementById("date").value;
        const time = document.getElementById("time").value;

        if (!date) {
          showAlert("è¯·é€‰æ‹©æ—¥æœŸ", "error");
          return null;
        }

        let dateTime = date;
        if (time && time.match(/^\d{1,2}:\d{2}$/)) {
          const [hours, minutes] = time.split(":").map(Number);
          dateTime += `T${String(hours).padStart(2, "0")}:${String(
            minutes
          ).padStart(2, "0")}:00`;
        } else {
          dateTime += "T12:00:00";
        }

        return new Date(dateTime);
      }

      async function saveData() {
        const dateTime = getDateTime();
        if (!dateTime) return;

        const count = parseInt(document.getElementById("count").value);
        if (isNaN(count) || count < 0) {
          showAlert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç´¯è®¡è„‰å†²æ•°", "error");
          return;
        }

        try {
          const timestamp = Math.floor(dateTime.getTime() / 1000);
          await fetchJSON("/debug/insert-event", {
            method: "POST",
            body: JSON.stringify({
              timestamp: timestamp,
              count: count,
            }),
          });

          showAlert("æ•°æ®ä¿å­˜æˆåŠŸ", "success");
          clearDataForm();
          loadRecentData();
        } catch (err) {
          showAlert("ä¿å­˜å¤±è´¥: " + err.message, "error");
          console.error("ä¿å­˜å¤±è´¥:", err);
        }
      }

      function clearDataForm() {
        document.getElementById("date").value = "";
        document.getElementById("count").value = "";
        document.getElementById("time").value = "";
      }

      async function loadCurrentData() {
        try {
          const data = await fetchJSON("/debug/events");
          if (data.latest_event) {
            const latest = data.latest_event;
            const date = new Date(latest.timestamp * 1000);

            document.getElementById("date").value = date
              .toISOString()
              .split("T")[0];
            document.getElementById("time").value = date
              .toTimeString()
              .slice(0, 5);
            document.getElementById("count").value = latest.count;

            showAlert("å·²åŠ è½½æœ€æ–°æ•°æ®", "success");
          } else {
            showAlert("æš‚æ— æ•°æ®", "info");
          }
        } catch (err) {
          showAlert("åŠ è½½æ•°æ®å¤±è´¥: " + err.message, "error");
        }
      }

      async function loadRecentData() {
        try {
          const data = await fetchJSON("/debug/events");
          const tbody = document.getElementById("data-tbody");

          if (!data.recent_events || data.recent_events.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = "";
          data.recent_events.reverse().forEach((event) => {
            const row = tbody.insertRow();
            const date = new Date(event.timestamp * 1000);

            row.innerHTML = `
              <td>${date.toLocaleString()}</td>
              <td>${event.count}</td>
              <td>
                <button onclick="deleteEvent(${event.timestamp}, ${
              event.count
            })" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
              </td>
            `;
          });
        } catch (err) {
          showAlert("åŠ è½½æ•°æ®å¤±è´¥: " + err.message, "error");
        }
      }

      async function deleteEvent(timestamp, count) {
        if (
          !confirm(
            `ç¡®å®šè¦åˆ é™¤è¿™æ¡æ•°æ®å—ï¼Ÿ\næ—¶é—´: ${new Date(
              timestamp * 1000
            ).toLocaleString()}\nè„‰å†²æ•°: ${count}`
          )
        ) {
          return;
        }

        try {
          await fetchJSON("/debug/delete-event", {
            method: "POST",
            body: JSON.stringify({ timestamp: timestamp, count: count }),
          });
          showAlert("åˆ é™¤æˆåŠŸ", "success");
          loadRecentData();
        } catch (err) {
          showAlert("åˆ é™¤å¤±è´¥: " + err.message, "error");
        }
      }

      async function clearAllData() {
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
          return;
        }

        try {
          await fetchJSON("/debug/clear-events", { method: "POST" });
          showAlert("æ‰€æœ‰æ•°æ®å·²æ¸…ç©º", "success");
          loadRecentData();
        } catch (err) {
          showAlert("æ¸…ç©ºå¤±è´¥: " + err.message, "error");
        }
      }

      async function batchSetData() {
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
        const dailyIncrease = parseInt(
          document.getElementById("daily-increase").value
        );
        const startCount = parseInt(
          document.getElementById("start-count").value
        );

        if (!startDate || !endDate) {
          showAlert("è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ", "error");
          return;
        }

        if (isNaN(dailyIncrease) || dailyIncrease < 0) {
          showAlert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯æ—¥å¢åŠ è„‰å†²æ•°", "error");
          return;
        }

        if (isNaN(startCount) || startCount < 0) {
          showAlert("è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·å§‹ç´¯è®¡æ•°", "error");
          return;
        }

        try {
          const start = new Date(startDate);
          const end = new Date(endDate);
          const events = [];

          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            events.push({
              timestamp: Math.floor(d.getTime() / 1000),
              count:
                startCount +
                dailyIncrease * Math.floor((d - start) / (1000 * 60 * 60 * 24)),
            });
          }

          await fetchJSON("/debug/batch-insert-events", {
            method: "POST",
            body: JSON.stringify({ events: events }),
          });

          showAlert(`æˆåŠŸè®¾ç½® ${events.length} å¤©çš„æ•°æ®`, "success");
          loadRecentData();
        } catch (err) {
          showAlert("æ‰¹é‡è®¾ç½®å¤±è´¥: " + err.message, "error");
        }
      }

      // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("settings-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            saveAllSettings();
          });

        document
          .getElementById("telegram-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            saveTelegramSettings();
          });

        document
          .getElementById("test-telegram")
          .addEventListener("click", testTelegram);
        document
          .getElementById("load-config")
          .addEventListener("click", loadAllSettings);

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®å’Œæ•°æ®
        checkAuthAndShowLogout();
        loadAllSettings();
        loadRecentData();
      });
    </script>
  </body>
</html>
